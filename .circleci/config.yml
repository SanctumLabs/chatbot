version: 2
jobs:
       build:
                working_directory: ~/repo
                docker:
                        # specify the version you desire here
                        - image: circleci/android:api-26-alpha                   

                environment:
                        # Customize the JVM maximum heap limit
                        _JAVA_OPTIONS: "-XX:+UnlockExperimentalVMOptions -XX:+UseCGroupMemoryLimitForHeap"
                        # JVM_OPTS: -Xmx3200m
                        TERM: dumb
                
                steps:
                        # checkout onto repo
                        - checkout
                       
                        # Download and cache dependencies
                        - restore_cache:
                                keys:
                                        - jars-{{ checksum "build.gradle" }}-{{ checksum "app/build.gradle" }}
                        - run:
                                name: Download dependencies
                                command: ./gradlew androidDependencies
                        
                        - save_cache:
                                key: jars-{{ checksum "build.gradle" }}-{{ checksum "app/build.gradle" }}-{{ checksum "circle.yml" }}-{{ checksum "gradle/wrapper/gradle-wrapper.properties" }}
                                paths:
                                        - ~/.gradle
                                keys:
                                        - jars-{{ checksum "build.gradle" }}-{{ checksum "app/build.gradle" }}

        # run tests!
        test:
                working_directory: ~/repo
                docker:
                        # specify the version you desire here
                        - image: circleci/android:api-26-alpha
                
                steps:
                        # checkout onto repo
                        - checkout
                        - run:
                                name: Run Lint Tests
                                command: ./gradlew lint test
                        
                        - run:
                                name: Setup emulator
                                command: sdkmanager "system-images;android-22;default;armeabi-v7a" && echo "no" | avdmanager create avd -n test -k "system-images;android-22;default;armeabi-v7a"
                        
                        - run:
                                name: Launch emulator
                                command: export LD_LIBRARY_PATH=${ANDROID_HOME}/emulator/lib64:${ANDROID_HOME}/emulator/lib64/qt/lib && emulator64-arm -avd test -noaudio -no-boot-anim -no-window -accel on
                                background: true
                        
                        - run:
                                name: Run Tests
                                command: ./gradlew :app:connectedAndroidTest
                        
                        - store_artifacts:
                                path: app/build/reports
                                destination: reports
                        
                        - store_test_results:
                                path: app/build/test-results
        deploy:
                working_directory: ~/repo
                docker:
                        # specify the version you desire here
                        - image: circleci/android:api-26-alpha
                
                steps:
                        - checkout
                        - run:
                                name: Deploy to Play Store
                                command: ./gradlew :app:publishApkRelease
